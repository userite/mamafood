<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4A90E2">
    <meta name="description" content="–ú–ê–ú–ê–§–û–û–î - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞ —Å–ª–µ–¥–µ–µ–Ω–µ –Ω–∞ —Å—ä—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –∫—ä—Ä–º–∞">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ú–ê–ú–ê–§–û–û–î</title>
    <link rel="manifest" href="manifest.json?v=2">
    <link rel="stylesheet" href="styles.css?v=2">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üçº</text></svg>">
    <script src="i18n.js?v=2"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 data-i18n="appName">üçº –ú–ê–ú–ê–§–û–û–î</h1>
                <span class="child-info" id="childInfo" onclick="showChildCode()">
                    <span id="childCodeDisplayHeader"></span>
                    <span id="childNameDisplayHeader"></span>
                </span>
            </div>
            <div class="header-right">
                <button class="btn-child-code" onclick="showChildCode()" title="–ö–æ–¥ –Ω–∞ –¥–µ—Ç–µ—Ç–æ" id="btnChildCode">
                    üë∂
                </button>
                <div class="lang-buttons">
                    <button class="btn-lang" onclick="changeLanguage('bg')" title="–ë—ä–ª–≥–∞—Ä—Å–∫–∏">bg</button>
                    <button class="btn-lang" onclick="changeLanguage('en')" title="English">en</button>
                </div>
                <button class="btn-install" id="btnInstall" onclick="showInstallInstructions()" title="Add to Home Screen" style="display: none;">
                    üì±
                </button>
                <button class="btn-lang" id="btnPushStatus" onclick="testPush()" title="Push notifications" style="display: inline-flex;">üîî</button>
                <button class="btn-refresh" id="btnRefresh" onclick="refreshData()" title="–û–ø—Ä–µ—Å–Ω–∏ –¥–∞–Ω–Ω–∏—Ç–µ">‚ü≥</button>
                <button class="btn-add" id="btnAdd" aria-label="–î–æ–±–∞–≤–∏ –Ω–æ–≤ –∑–∞–ø–∏—Å">+</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- –†–∞–∑–¥–µ–ª –∑–∞ –∫—ä—Ä–º–∞ -->
            <div id="milk-section">
                <!-- –ó–∞–ø–∏—Å–∏ -->
                <section class="records-section" id="recordsSection">
                    <h2 data-i18n="currentPortions">–¢–µ–∫—É—â–∏ –ø–æ—Ä—Ü–∏–∏</h2>
                    <div id="recordsList" class="records-list">
                        <!-- Records will be dynamically inserted here -->
                    </div>
                    <p class="empty-state" id="emptyState" data-i18n="noRecords">–ù—è–º–∞ –∑–∞–ø–∏—Å–∏. –î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∞ –ø–æ—Ä—Ü–∏—è.</p>
                </section>

                <!-- –ò–∑—Ç–µ–∫–ª–∏ –ø–æ—Ä—Ü–∏–∏ -->
                <section class="records-section" id="expiredSection" style="display: none;">
                    <h2 style="color: var(--danger);" data-i18n="expiredPortions">–ò–∑—Ç–µ–∫–ª–∏ –ø–æ—Ä—Ü–∏–∏</h2>
                    <div id="expiredRecordsList" class="records-list">
                        <!-- Expired records will be dynamically inserted here -->
                    </div>
                </section>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <section class="stats-section">
                <h3 data-i18n="statistics">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="totalRecords">0</span>
                        <span class="stat-label" data-i18n="totalPortions">–û–±—â–æ –ø–æ—Ä—Ü–∏–∏</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="activeRecords">0</span>
                        <span class="stat-label" data-i18n="active">–ê–∫—Ç–∏–≤–Ω–∏</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="expiringRecords">0</span>
                        <span class="stat-label" data-i18n="expiringSoon">–ò–∑—Ç–∏—á–∞—Ç —Å–∫–æ—Ä–æ</span>
                    </div>
                </div>
                </section>
            </div>
        </main>

        <!-- Modal –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ -->
        <div class="modal" id="recordModal">
            <div class="modal-content">
                <button class="modal-close" id="modalClose">&times;</button>
                <h2 id="modalTitle" data-i18n="addPortion">–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤–∞ –ø–æ—Ä—Ü–∏—è</h2>
                <form id="recordForm" class="record-form">
                    <div class="form-group">
                        <label for="amount" data-i18n="amountLabel">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (ml)</label>
                        <input type="number" id="amount" name="amount" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="situation" data-i18n="situationLabel">–°–∏—Ç—É–∞—Ü–∏—è</label>
                        <select id="situation" name="situation" required>
                            <option value=""></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="datetime" data-i18n="datetimeLabel">–î–∞—Ç–∞ –∏ —á–∞—Å –Ω–∞ –∏–∑—Ü–µ–∂–¥–∞–Ω–µ</label>
                        <input type="datetime-local" id="datetime" name="datetime" required>
                    </div>

                    <div class="form-group">
                        <label for="notes" data-i18n="notesLabel">–ë–µ–ª–µ–∂–∫–∏ (–ø–æ –∏–∑–±–æ—Ä)</label>
                        <textarea id="notes" name="notes" rows="3" data-i18n-placeholder="notesPlaceholder"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" data-i18n="save">–ó–∞–ø–∞–∑–∏</button>
                        <button type="button" class="btn btn-secondary" id="btnCancel" data-i18n="cancel">–û—Ç–∫–∞–∑</button>
                    </div>

                    <input type="hidden" id="recordId" name="recordId">
                </form>
            </div>
        </div>
        
        <!-- Install Instructions Modal -->
        <div class="modal" id="installModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeInstallModal()">&times;</button>
                <h2 id="installTitle">–î–æ–±–∞–≤–∏ –∫—ä–º –Ω–∞—á–∞–ª–µ–Ω –µ–∫—Ä–∞–Ω</h2>
                <div id="installInstructions" style="padding: 1rem 0;">
                    <!-- Instructions will be shown here -->
                </div>
                <button class="btn btn-primary" onclick="closeInstallModal()">–†–∞–∑–±—Ä–∞—Ö</button>
            </div>
        </div>

        <!-- Child Code Modal -->
        <div class="modal" id="childCodeModal">
            <div class="modal-content">
                <button class="modal-close" id="modalChildCodeClose">&times;</button>
                <h2>üë∂ –ö–æ–¥ –Ω–∞ –¥–µ—Ç–µ—Ç–æ</h2>
                <div style="margin: 1.5rem 0;">
                    <label for="childCodeInputModal" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ö–æ–¥:</label>
                    <input type="text" id="childCodeInputModal" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∫–æ–¥" data-generated="false" style="width: 100%; padding: 0.75rem; font-size: 1.2rem; text-align: center; text-transform: uppercase; border: 2px solid var(--primary-color); border-radius: 8px;" />
                </div>
                <div style="margin: 1.5rem 0;">
                    <label for="childNameInputModal" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ò–º–µ:</label>
                    <input type="text" id="childNameInputModal" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ (–Ω–∞–ø—Ä. –ö–∞–π)" style="width: 100%; padding: 0.75rem; font-size: 1.2rem; text-align: center; border: 2px solid var(--primary-color); border-radius: 8px;" />
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="generateNewChildCode()" style="flex: 1;">üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –Ω–æ–≤ –∫–æ–¥</button>
                    <button class="btn btn-primary" onclick="saveChildCodeAndName()" style="flex: 1;">‚úÖ OK</button>
                    <button class="btn btn-secondary" onclick="closeChildCodeModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app_v2.js?v=10"></script>
    <script>
        // Cache busting and force reload mechanism
        const APP_VERSION = '10';
        
        // –ê–≥—Ä–µ—Å–∏–≤–Ω–æ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –∫–µ—à–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        (async function clearOldCache() {
            console.log('[Cache] –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä–∏ –∫–µ—à–æ–≤–µ...');
            
            // –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ Service Workers
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const reg of registrations) {
                        await reg.unregister();
                        console.log('[Cache] Service Worker –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç:', reg.scope);
                    }
                } catch (e) {
                    console.warn('[Cache] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ Service Workers:', e);
                }
            }
            
            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –∫–µ—à–æ–≤–µ
            try {
                const cacheNames = await caches.keys();
                for (const name of cacheNames) {
                    await caches.delete(name);
                    console.log('[Cache] –ö–µ—à –∏–∑—á–∏—Å—Ç–µ–Ω:', name);
                }
            } catch (e) {
                console.warn('[Cache] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –∫–µ—à–æ–≤–µ:', e);
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–µ—Ä—Å–∏—è—Ç–∞
            const currentVersion = localStorage.getItem('mamafood_version');
            if (currentVersion && currentVersion !== APP_VERSION) {
                console.log(`[Cache] –í–µ—Ä—Å–∏—è –ø—Ä–æ–º–µ–Ω–µ–Ω–∞ –æ—Ç ${currentVersion} –Ω–∞ ${APP_VERSION}, –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ localStorage...`);
                // –ù–ï –∏–∑—á–∏—Å—Ç–≤–∞–º–µ –≤—Å–∏—á–∫–æ, —Å–∞–º–æ –≤–µ—Ä—Å–∏—è—Ç–∞
            }
            localStorage.setItem('mamafood_version', APP_VERSION);
            
            console.log('[Cache] –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ—Ç–æ –ø—Ä–∏–∫–ª—é—á–∏');
        })();
        const VERSION_KEY = 'mamafood_version';
        
        // Check for version update
        const storedVersion = localStorage.getItem(VERSION_KEY);
        if (storedVersion && storedVersion !== APP_VERSION) {
            // New version detected - clear caches and reload
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
            localStorage.setItem(VERSION_KEY, APP_VERSION);
            location.reload(true);
        } else if (!storedVersion) {
            localStorage.setItem(VERSION_KEY, APP_VERSION);
        }
        
        // Register Service Worker with cache busting
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service Worker —Ä–∞–±–æ—Ç–∏ —Å–∞–º–æ —Å HTTP/HTTPS, –Ω–µ —Å file://
                if (window.location.protocol === 'file:') {
                    console.log('Service Worker –Ω–µ –º–æ–∂–µ –¥–∞ —Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞ —Å file:// –ø—Ä–æ—Ç–æ–∫–æ–ª. –ò–∑–ø–æ–ª–∑–≤–∞–π HTTP —Å—ä—Ä–≤—ä—Ä.');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ service worker —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register(`./service-worker.js?v=${APP_VERSION}`)
                        .then(registration => {
                            console.log('Service Worker registered:', registration);
                            
                            // Check for updates every hour
                            setInterval(() => {
                                registration.update();
                            }, 3600000);
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
            });
        }
        
        // Force reload button (for mobile)
        window.addEventListener('load', () => {
            // Add long-press reload on logo
            const logo = document.querySelector('h1');
            if (logo) {
                let pressTimer;
                logo.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        if (confirm('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª–Ω–æ –ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ?')) {
                            clearAllCaches();
                        }
                    }, 2000);
                });
                logo.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });
            }
        });
        
        // Function to clear all caches
        function clearAllCaches() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
            localStorage.removeItem(VERSION_KEY);
            location.reload(true);
        }
        
        // Expose globally
        window.clearAllCaches = clearAllCaches;
    </script>
</body>
</html>

