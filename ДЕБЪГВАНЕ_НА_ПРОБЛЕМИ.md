# Дебъгване на проблеми с базата данни

## Проблем: Не се показват записи

### Стъпка 1: Проверка на връзката с базата данни

Стартирай тест скрипта:
```bash
test-database.bat
```

Или ръчно:
```bash
node test-database.js
```

Това ще провери:
- ✅ Дали DATABASE_URL е зададен
- ✅ Дали може да се свърже с базата
- ✅ Дали таблиците съществуват
- ✅ Дали има записи за код "KAI"
- ✅ Какви кодове има в базата

### Стъпка 2: Проверка на .env файла

Увери се, че имаш `.env` файл в root директорията с:
```
DATABASE_URL=postgresql://username:password@host:port/database
PORT=3000
```

**Важно:** 
- Ако използваш локална PostgreSQL: `postgresql://postgres:postgres@localhost:5432/mamafood`
- Ако използваш Render.com: Вземи connection string от Render dashboard
- Ако използваш друг cloud provider: Използвай техния connection string

### Стъпка 3: Проверка на backend сървъра

1. Стартирай backend сървъра:
   ```bash
   start-backend.bat
   ```

2. Провери дали сървърът стартира без грешки
3. Виж дали има съобщения като:
   - ✅ `Database connection successful`
   - ✅ `Table "records" is ready`
   - ❌ Ако виждаш грешки, провери DATABASE_URL

### Стъпка 4: Тест на API endpoint-ите

Отвори в браузър или използвай curl:

**Health check:**
```
http://localhost:3000/api/health
```
Трябва да върне: `{"status":"ok","timestamp":"..."}`

**Проверка на записи за "KAI":**
```
http://localhost:3000/api/records/KAI
```
Трябва да върне JSON масив с записите.

**Проверка на дете "KAI":**
```
http://localhost:3000/api/children/KAI
```

### Стъпка 5: Проверка на frontend-а

1. Отвори приложението в браузър
2. Натисни F12 (Developer Tools)
3. Отиди на вкладка "Console"
4. Провери за грешки (червени съобщения)
5. Отиди на вкладка "Network"
6. Презареди страницата
7. Провери дали има заявки към `/api/records/KAI`
8. Кликни на заявката и провери Response

### Стъпка 6: Проверка на childCode в localStorage

В браузър конзолата (F12 → Console), въведи:
```javascript
localStorage.getItem('mamafood_child_code')
```

Това трябва да върне "KAI" (или какъвто код искаш).

Ако не е "KAI", задай го:
```javascript
localStorage.setItem('mamafood_child_code', 'KAI');
location.reload();
```

## Често срещани проблеми

### Проблем 1: "DATABASE_URL не е зададен"
**Решение:** Създай `.env` файл с правилния connection string

### Проблем 2: "Connection refused" или "ECONNREFUSED"
**Решение:** 
- Провери дали PostgreSQL сървърът работи
- Провери дали host, port, username, password са правилни
- Провери firewall настройките

### Проблем 3: "Authentication failed"
**Решение:** Провери username и password в DATABASE_URL

### Проблем 4: "Database does not exist"
**Решение:** Създай базата данни или използвай правилното име в connection string

### Проблем 5: "CORS error" в браузъра
**Решение:** Провери дали backend сървърът работи и дали CORS е конфигуриран правилно

### Проблем 6: Записите не се показват, но API връща празен масив []
**Решение:** 
- Провери дали има записи в базата за този код
- Използвай `test-database.js` за проверка
- Провери дали кодът в базата е точно "KAI" (може да е "kai" или друг вариант)

## Полезни команди

**Проверка на всички записи в базата:**
```sql
SELECT child_code, COUNT(*) as count 
FROM records 
GROUP BY child_code;
```

**Проверка на записи за конкретен код:**
```sql
SELECT * FROM records WHERE UPPER(child_code) = 'KAI' ORDER BY datetime DESC;
```

**Проверка на children таблицата:**
```sql
SELECT * FROM children WHERE UPPER(child_code) = 'KAI';
```

